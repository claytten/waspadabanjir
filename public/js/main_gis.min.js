"use strict";let url=window.location.origin+"/",maps=L.map("mapid",{fullscreenControl:!0,center:new L.LatLng(-7.694512268978755,110.67233986914458),zoom:12});L.tileLayer("http://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}",{maxZoom:60,subdomains:["mt0","mt1","mt2","mt3"]}).addTo(maps);let startPolylineFlag=!1,polyline,pols=[],polygon,helpLine,helpPolygon,color,firstPoint=L.circleMarker(),drawingState=!1,savePolygon=[];const startDrawingButton=L.easyButton({id:"start-drawing-button",states:[{icon:"fa fa-pen",title:"Mulai Menggambar",stateName:"start-polyline",onClick(a,e){a.button.style.backgroundColor="#f00",a.button.style.color="#fff",document.getElementById("mapid").style.cursor="crosshair",a.state("cancel-polyline"),drawingState=!0}},{icon:"fa fa-times",title:"Batalkan Menggambar",stateName:"cancel-polyline",onClick(a,e){a.button.style.backgroundColor="#fff",a.button.style.color="#000",document.getElementById("mapid").style.cursor="grab",a.state("start-polyline"),cancelPolyline()}}]});startDrawingButton.addTo(maps);const undoButton=L.easyButton({id:"undo-polyline",states:[{icon:"fa fa-undo",ttle:"Batalkan titik terakhir",stateName:"undo-polyline",onClick(a,e){undoPoint()}}]});undoButton.addTo(maps),undoButton.disable();const undoPoint=()=>{drawingState&&0!=pols.length&&(pols.pop(),polyline.setLatLngs(pols),helpPolygon.setLatLngs(pols),validateArea()||finishButton.disable(),0==pols.length&&(finishPolyline(),undoButton.disable()))},finishButton=L.easyButton({id:"finish-polyline",states:[{icon:"fas fa-map",title:"Selesai Menggambar",stateName:"finish-polyline",onClick(a,e){drawingState=!0,drawArea(),finishButton.disable(),undoButton.disable(),startDrawingButton.disable()}}]});finishButton.addTo(maps),finishButton.disable();const searchControl=new L.esri.Controls.Geosearch().addTo(maps),results=new L.LayerGroup().addTo(maps);searchControl.on("results",function(a){results.clearLayers()}),setTimeout(function(){$(".pointer").fadeOut("slow")},3400);const cancelPolyline=()=>{void 0!==polyline&&(removeMapLayers(),finishPolyline())},finishPolyline=()=>{removeMapLayers(),startPolylineFlag=!1,pols=[],polygon=void 0,polyline=void 0,helpLine=void 0,helpPolygon=void 0,finishButton.disable(),undoButton.disable()},removeMapLayers=()=>{maps.removeLayer(polyline),maps.removeLayer(helpLine),maps.removeLayer(helpPolygon),maps.removeLayer(firstPoint)},onMapClick=a=>{drawingState&&(!0!=startPolylineFlag?(startPolyline(a.latlng),pols.push([a.latlng.lat,a.latlng.lng]),polyline=L.polyline(pols,{color:"#ee3"}).addTo(maps)):(pols.push([a.latlng.lat,a.latlng.lng]),polyline.addLatLng(a.latlng),undoButton.enable(),validateArea()&&(drawHelpArea(),finishButton.enable())))},onMapMouseMove=a=>{if(!drawingState||pols.length<1)return;let e=[pols[pols.length-1],[a.latlng.lat,a.latlng.lng]];helpLine?helpLine.setLatLngs(e):(helpLine=L.polyline(e,{color:"grey",weight:2,dashArray:"7",className:"help-layer"})).addTo(maps)},startPolyline=a=>{placeFirstPoint(a),startPolylineFlag=!0},placeFirstPoint=a=>{let e=L.divIcon({className:"first-point",iconSize:[10,10],iconAnchor:[5,5]});(firstPoint=L.marker(a,{icon:e,icon:e})).addTo(maps),firstPoint.on("click",()=>{validateArea()&&drawArea()})},validateArea=()=>(console.log(pols),pols.length>2),drawArea=()=>{if(void 0===polyline||!validateArea())return;drawingState=!1;let a="#"+function a(e){return(e+=[0,1,2,3,4,5,6,7,8,9,"a","b","c","d","e","f"][Math.floor(16*Math.random())])&&6==e.length?e:a(e)}(""),e=(polygon=L.polygon([pols],{color:a,fillOpacity:.4}).addTo(maps)).toGeoJSON(15);$(`
  <form id="mapsForm" action="${urlPOST}" method="POST" enctype='multipart/form-data'>
  <input type="hidden" name="_token" value="${$('meta[name="csrf-token"]').attr("content")}">
  <div class="card-wrapper">
    <div class="card">
      <div class="row">
        <div class="col-lg-12">
          <div class="card-header">
            <div class="row align-items-center">
              <div class="col-lg-8 col-md-6">
                <h3 class="mb-0" id="form-map-title">Buat Data Peta</h3>
              </div>
              <div class="col-lg-4 col-md-6 d-flex justify-content-end">
                <button type="button" class="btn btn-danger" onclick="cancelArea()">Batalkan</button>
                <button type="button" class="btn btn-warning" onclick="resetForm()" >Atur Ulang</button>
                <button type="submit" class="btn btn-primary" id="btn-submit" >Submit</button>
              </div>
            </div>
          </div>
        </div>

        <div class="col-lg-12">
          <div class="row">
            <div class="col-lg-6">
              <div class="card-body">
                <div class="row">
                  <div class="col-md-12">
                    <div class="form-group">
                      <div class="input-group input-group-merge">
                        <div class="input-group-prepend">
                          <span class="input-group-text"><i class="fas fa-book-dead"></i></span>
                        </div>
                        <input type="number" id="deaths" class="form-control" name="deaths" placeholder="Jumlah korban yang meninggal" step="1" min="0">
                      </div>
                    </div>
                  </div>
                  <div class="col-md-12">
                    <div class="form-group">
                      <div class="input-group input-group-merge">
                        <div class="input-group-prepend">
                          <span class="input-group-text"><i class="fas fa-user-injured"></i></span>
                        </div>
                        <input type="number" id="injured" class="form-control" name="injured" placeholder="Jumlah korban yang mengalami luka kecil/berat" step="1" min="0">
                      </div>
                    </div>
                  </div>
                  <div class="col-md-12">
                    <div class="form-group">
                      <div class="input-group input-group-merge">
                        <div class="input-group-prepend">
                          <span class="input-group-text"><i class="fas fa-user-slash"></i></span>
                        </div>
                        <input type="number" id="losts" class="form-control" name="losts" placeholder="Jumlah korban yang hilang" step="1" min="0">
                      </div>
                    </div>
                  </div>
                  <div class="col-md-12 btn-date-out-field">
                    <div class="row">
                      <div class="col-md-8">
                        <div class="form-group">
                          <div class="input-group input-group-merge">
                            <div class="input-group-prepend">
                              <span class="input-group-text"><i class="fa fa-calendar" aria-hidden="true"></i></span>
                            </div>
                            <input class="form-control" placeholder="Pilih tanggal awal kejadian" type="text" name="date_in" id="date_in" onchange="setDateOut()">
                          </div>
                        </div>
                      </div>

                      <div class="col-md-4">
                        <div class="form-group">
                          <div class="input-group input-group-merge">
                            <div class="input-group-prepend">
                              <span class="input-group-text"><i class="fa fa-clock-o" aria-hidden="true"></i></span>
                            </div>
                            <input class="form-control" type="time" value="00:00:00" id="example-time-input" name="date_in_time">
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-12">
                    <div class="form-group">
                      <button type="button" class="btn btn-info" data-toggle="tooltip" data-placement="top" title="Button ini berfungsi mengaktifkan tanggal berakhir banjir atau tidak" onclick="setDateOutField()" id="btn-set-date-out">Atur tanggal berakhirnya banjir</button>
                    </div>
                  </div>
                  <div class="col-md-12 btn-detail-locations">
                    <div class="form-group">
                      <div class="input-group input-group-merge">
                        <button type="button" class="btn btn-info" data-toggle="modal" data-target="#modal-add-address">Tambahkan Rincian Lokasi</button>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-12">
                    <div class="form-group">
                      <div class="input-group input-group-merge">
                        <div class="input-group-prepend">
                          <span class="input-group-text"><i class="fas fa-info"></i></span>
                        </div>
                        <textarea class="form-control" placeholder="Kronologi" name="description" id="description"></textarea>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-lg-6">
              <div class="card-body">
                <div class="row">
                  <div class="col-md-12">
                    <div class="form-group row">
                      <label for="example-text-input" class="col-md-2 col-form-label form-control-label">Level Banjir</label>
                      <div class="col-md-10">
                        <select name="level" id="level" class="form-control" data-toggle="select">
                          <option value=""></option>
                          <option value="1" title="Debit air meningkat atau tidak surut kurun waktu 6 jam. Warga harus mengungsi dari lokasi bencana banjir">Siaga 1</option>
                          <option value="2" title="Debit air meningkatan signifikan dan meluas dari pintu air. Warga diminta segera mengungsi.">Siaga 2</option>
                          <option value="3" title="Terdapat peningkatan debit air disekitar pintu air. Warga diminta berhati-hati.">Siaga 3</option>
                          <option value="4" title="Belum ada peningkatan debit air disekitar pintu air. Warga masih tergolong aman.">Siaga 4</option>
                        </select>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-12" id="status-form">
                    <div class="form-group row">
                      <label for="example-text-input" class="col-md-2 col-form-label form-control-label">Status Penerbitan</label>
                      <div class="col-md-10">
                        <select name="status" id="status" class="form-control" data-toggle="select" onchange="statusAction()">
                          <option value=""></option>
                          <option value="1">Terbitkan</option>
                          <option value="0">Draft</option>
                        </select>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-12">
                    <div class="form-group">
                      <div class="dropzone dropzone-multiple" data-toggle="dropzone" data-dropzone-multiple data-dropzone-url="#">
                        <div class="fallback">
                          <div class="custom-file">
                            <input type="file" class="custom-file-input" id="customFileUploadMultiple" multiple>
                            <label class="custom-file-label" for="customFileUploadMultiple">Choose file</label>
                          </div>
                        </div>
                        <ul class="dz-preview dz-preview-multiple list-group list-group-lg list-group-flush">
                          <li class="list-group-item px-0">
                            <div class="row align-items-center">
                              <div class="col-auto">
                                <div class="avatar">
                                  <img class="avatar-img rounded" src="..." alt="..." data-dz-thumbnail>
                                </div>
                              </div>
                              <div class="col ml--3">
                                <h4 class="mb-1" data-dz-name>...</h4>
                                <p class="small text-muted mb-0" data-dz-size>...</p>
                              </div>
                              <div class="col-auto">
                                <div class="dropdown">
                                  <a href="#" class="dropdown-ellipses dropdown-toggle" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    <i class="fe fe-more-vertical"></i>
                                  </a>
                                  <div class="dropdown-menu dropdown-menu-right">
                                    <a href="#" class="dropdown-item" data-dz-remove>
                                      Remove
                                    </a>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </li>
                        </ul>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  </form>
  `).appendTo($("#formtable")).slideDown("slow","swing"),$("#btn-set-date-out").prop("disabled",!0).tooltip(),$("#mapsForm").append('<input type="text" class="form-control" id="area" name="area" style="display:none">'),$("#mapsForm").append('<input type="text" class="form-control" id="color" name="color" style="display:none" value="'+a+'">'),$("#level").select2({placeholder:"Select Level"}),$("#status").select2({placeholder:"Select Status"}),$("#date_out").select2({placeholder:"Select Date Out"}),$("#area").val(JSON.stringify(e.geometry.coordinates)),function(){let a=$('[data-toggle="dropzone"]'),e=$(".dz-preview");a.length&&(Dropzone.autoDiscover=!1,a.each(function(){!function(a){let t=void 0!==a.data("dropzone-multiple"),o=a.find(e),l,i={url:a.data("dropzone-url"),autoProcessQueue:!1,uploadMultiple:!0,thumbnailWidth:null,thumbnailHeight:null,previewsContainer:o.get(0),previewTemplate:o.html(),maxFiles:t?null:1,acceptedFiles:t?null:"image/*",init:function(a){this.on("addedfile",function(a){!t&&l&&(this.removeFile(l),console.log("this is while remove item ",a)),l=a,$("#mapsForm").append(`<input type="file" class="custom-file-input images" id="${a.upload.uuid}" name="images[]" style="display:none">`);let e=new DataTransfer,o=document.getElementById(a.upload.uuid);e.items.add(a),o.files=e.files}),this.on("removedfile",function(a){$("#"+a.upload.uuid).remove()})}};o.html(""),a.dropzone(i)}($(this))}))}(),function(){let a=$("#date_in");a.length&&a.each(function(){!function(a){a.datepicker({disableTouchKeyboard:!0,autoclose:!1})}($(this))})}()},cancelArea=()=>{drawingState=!0,maps.removeLayer(polygon),finishButton.enable(),undoButton.enable(),startDrawingButton.enable(),$("#mapsForm").remove()},drawHelpArea=()=>{void 0!==polyline&&validateArea()&&(helpPolygon?helpPolygon.setLatLngs(pols):(helpPolygon=L.polygon([pols],{color:"#ee0",stroke:!1,className:"help-layer"})).addTo(maps))},onKeyDownEnter=()=>{drawArea(),finishButton.disable(),undoButton.disable(),startDrawingButton.disable()},onKeyDownEscape=()=>{cancelPolyline()};maps.on("click",onMapClick),maps.addEventListener("mousemove",onMapMouseMove),document.onkeydown=a=>{if(drawingState)switch(a.keyCode){case 13:onKeyDownEnter();break;case 27:onKeyDownEscape()}},L.geoJSON(getGeoJSONData(),{style:function(a){return{color:a.properties.popupContent.level.color}},onEachFeature:onEachFeatureCallback}).addTo(maps);const showPath=a=>{for(var e in console.log(a),savePolygon){var t;savePolygon[e].feature.properties.popupContent.id==a&&($("#mapsLayout").toggle(200),maps.fitBounds(savePolygon[e].getBounds()),savePolygon[e].openPopup())}};