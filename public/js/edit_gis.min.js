"use strict";let url=window.location.origin+"/",maps=L.map("mapid",{fullscreenControl:!0,center:new L.LatLng(-7.694512268978755,110.67233986914458),zoom:12});L.tileLayer("http://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}",{maxZoom:60,subdomains:["mt0","mt1","mt2","mt3"]}).addTo(maps);let startPolylineFlag=!1,polyline,pols=[],polygon,helpLine,helpPolygon,color,firstPoint=L.circleMarker(),drawingState=!1,polylayer,randCol="#"+function e(o){return(o+=[0,1,2,3,4,5,6,7,8,9,"a","b","c","d","e","f"][Math.floor(16*Math.random())])&&6==o.length?o:e(o)}("");const searchControl=new L.esri.Controls.Geosearch().addTo(maps),results=new L.LayerGroup().addTo(maps);searchControl.on("results",function(e){results.clearLayers()}),setTimeout(function(){$(".pointer").fadeOut("slow")},3400);const startDrawingButton=L.easyButton({id:"start-drawing-button",states:[{icon:"fa fa-pen",title:"Mulai Menggambar",stateName:"start-polyline",onClick(e,o){e.button.style.backgroundColor="#f00",e.button.style.color="#fff",document.getElementById("mapid").style.cursor="crosshair",console.log(e),e.state("cancel-polyline"),drawingState=!0,maps.removeLayer(polylayer)}},{icon:"fa fa-times",title:"Batalkan Menggambar",stateName:"cancel-polyline",onClick(e,o){e.button.style.backgroundColor="#fff",e.button.style.color="#000",document.getElementById("mapid").style.cursor="grab",e.state("start-polyline"),cancelPolyline(),polylayer.addTo(maps)}}]});startDrawingButton.addTo(maps);const undoButton=L.easyButton({id:"undo-polyline",states:[{icon:"fa fa-undo",ttle:"Batalkan titik terakhir",stateName:"undo-polyline",onClick(e,o){undoPoint()}}]});undoButton.addTo(maps),undoButton.disable();const undoPoint=()=>{drawingState&&0!=pols.length&&(pols.pop(),polyline.setLatLngs(pols),helpPolygon.setLatLngs(pols),validateArea()||finishButton.disable(),0==pols.length&&(finishPolyline(),undoButton.disable()))},finishButton=L.easyButton({id:"finish-polyline",states:[{icon:"fas fa-map",title:"Selesai Menggambar",stateName:"finish-polyline",onClick(e,o){drawingState=!0,drawArea(),finishButton.disable(),undoButton.disable(),startDrawingButton.disable()}}]});finishButton.addTo(maps),finishButton.disable();const cancelPolyline=()=>{void 0!==polyline&&(removeMapLayers(),finishPolyline())},finishPolyline=()=>{removeMapLayers(),startPolylineFlag=!1,pols=[],polygon=void 0,polyline=void 0,helpLine=void 0,helpPolygon=void 0,startDrawingButton.enable(),startDrawingButton.state("start-polyline"),startDrawingButton.button.style.backgroundColor="#fff",startDrawingButton.button.style.color="#000",document.getElementById("mapid").style.cursor="grab",finishButton.disable(),undoButton.disable()},removeMapLayers=()=>{maps.removeLayer(polyline),maps.removeLayer(helpLine),maps.removeLayer(helpPolygon),maps.removeLayer(firstPoint)},onMapClick=e=>{drawingState&&(!0!=startPolylineFlag?(startPolyline(e.latlng),pols.push([e.latlng.lat,e.latlng.lng]),polyline=L.polyline(pols,{color:"#ee3"}).addTo(maps)):(pols.push([e.latlng.lat,e.latlng.lng]),polyline.addLatLng(e.latlng),undoButton.enable(),validateArea()&&(drawHelpArea(),finishButton.enable())))},onMapMouseMove=e=>{if(!drawingState||pols.length<1)return;let o=[pols[pols.length-1],[e.latlng.lat,e.latlng.lng]];helpLine?helpLine.setLatLngs(o):(helpLine=L.polyline(o,{color:"grey",weight:2,dashArray:"7",className:"help-layer"})).addTo(maps)},startPolyline=e=>{placeFirstPoint(e),startPolylineFlag=!0},placeFirstPoint=e=>{let o=L.divIcon({className:"first-point",iconSize:[10,10],iconAnchor:[5,5]});(firstPoint=L.marker(e,{icon:o,icon:o})).addTo(maps),firstPoint.on("click",()=>{validateArea()&&drawArea()})},validateArea=()=>(console.log(pols),pols.length>2),drawArea=async()=>{void 0!==polyline&&validateArea()&&(drawingState=!1,polygon=L.polygon([pols],{color:randCol,fillOpacity:.4}).addTo(maps),await Swal.fire({title:"Are you sure?",text:"You won't be able to revert this!",icon:"warning",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"Yes, delete it!",allowOutsideClick:!1,allowEscapeKey:!1}).then(e=>{e.isConfirmed&&updateGeoJSONData(randCol),e.isDismissed&&cancelArea()}),drawingState=!0,finishPolyline())},cancelArea=()=>{drawingState=!0,maps.removeLayer(polygon),finishButton.enable(),undoButton.enable(),startDrawingButton.enable(),startDrawingButton.state("cancel-polyline"),polylayer.addTo(maps)},drawHelpArea=()=>{void 0!==polyline&&validateArea()&&(helpPolygon?helpPolygon.setLatLngs(pols):(helpPolygon=L.polygon([pols],{color:"#ee0",stroke:!1,className:"help-layer"})).addTo(maps))},onKeyDownEnter=()=>{drawArea()},onKeyDownEscape=()=>{cancelPolyline()},getGeoJSONData=()=>{let e;return $.ajax({headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")},url:linkEdit,type:"GET",async:!1,cache:!1,error:function(e,o,t){console.log(e.responseText)},success:function(o){e=o.data,console.log("this is response",o,url)}}),e},onEachFeatureCallback=(e,o)=>{e.properties&&(polygon=L.polygon([e.geometry.coordinates],{color:e.properties.color,fillOpacity:.4}))},updateGeoJSONData=e=>{let o=polygon.toGeoJSON(15);$.ajax({headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")},url:link,type:"PUT",async:!1,cache:!1,data:{color:e,area:JSON.stringify(o.geometry.coordinates)},error:function(e,o,t){console.log(e.responseText)},success:function(e){"success"===e.status?(console.log("updateGeoJSON",polygon),polylayer=polygon,Swal.fire("Saved!","","success")):(maps.removeLayer(polygon),polylayer.addTo(maps),Swal.fire({icon:"error",title:"Oops...",text:"Something went wrong!"}))}})};maps.on("click",onMapClick),maps.addEventListener("mousemove",onMapMouseMove),document.onkeydown=e=>{if(drawingState)switch(e.keyCode){case 13:onKeyDownEnter();break;case 27:onKeyDownEscape()}},polylayer=L.geoJSON(getGeoJSONData(),{style:function(e){return{color:e.properties.level.color}},onEachFeature:onEachFeatureCallback}).addTo(maps),maps.fitBounds(polylayer.getBounds());